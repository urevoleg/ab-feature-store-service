# Trigger Engine

Trigger Engine — это Python-сервис для обработки событий мобильного приложения
и вычисления пользовательских флагов и метрик на основе YAML-описанных триггеров.

Сервис читает события из Kafka, декодирует `binaryData`, извлекает события,
применяет правила (триггеры) и накапливает состояние пользователей
(флаги и счётчики).

---

## Основные возможности

- Чтение событий из Kafka (`event-stream-v1`)
- Поддержка нескольких событий внутри одного сообщения
- YAML-конфигурация триггеров (без изменения кода)
- Два типа триггеров:
  - **flag** — срабатывает один раз в день на пользователя
  - **metric** — считает количество событий
- Простой DSL для фильтрации событий (`=`, `in`, `and`, `or`)
- InMemory state store (для локальной разработки)
- Готовность к расширению (Redis, S3, Iceberg)

---

## Поддерживаемые события (пример)

- `app_launch`
- `auth`
- `add_to_cart`
- `product_view`
- `product_listing`
- `mainpage_click`

---

## Архитектура

```text
Kafka (event-stream-v1)
        │
        ▼
┌────────────────────┐
│ Kafka Consumer     │
│ (kafka-python)     │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ Binary Decoder     │
│ base64 → JSON      │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ Event Extractor    │
│ event_prop[]       │
│ magnit_id          │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ Trigger Engine     │
│ YAML + DSL         │
│ flag / metric      │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ State Store        │
│ InMemory (per day) │
└────────────────────┘
